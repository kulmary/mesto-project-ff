(()=>{"use strict";var t=document.querySelector("#card-template").content;function e(e,n,o,r,c){var i=t.querySelector(".card").cloneNode(!0);i.querySelector(".card__title").textContent=e.name;var a=i.querySelector(".card__image"),u=i.querySelector(".card__likes");i.setAttribute("id",e._id),i.setAttribute("owner_id",e.owner._id),a.src=e.link,a.alt=e.name,u.textContent=e.likes.length;var l=i.querySelector(".card__delete-button"),s=i.querySelector(".card__like-button");return l.addEventListener("click",o),n!==e.owner._id&&l.remove(),e.likes.forEach((function(t){t._id===n&&s.classList.add("card__like-button_is-active")})),a.addEventListener("click",(function(){c(e)})),s.addEventListener("click",r),i}var n=function(t){t.classList.add("popup_is-opened"),document.addEventListener("keydown",r)},o=function(t){t.classList.remove("popup_is-opened"),document.removeEventListener("keydown",r)},r=function(t){if("Escape"===t.key){var e=document.querySelector(".popup_is-opened");o(e)}};function c(t,e,n){t.classList.remove(n.inputErrorClass),e.classList.remove(n.errorClass),e.textContent=t.validationMessage}function i(t,e){t.classList.remove(e.inactiveButtonClass),t.disabled=!1}function a(t,e,n){e?i(t,n):function(t,e){t.classList.add(e.inactiveButtonClass),t.disabled=!0}(t,n)}function u(t,e){var n=t.querySelectorAll(e.inputSelector),o=t.querySelector(e.submitButtonSelector);n.forEach((function(n){c(n,t.querySelector("#".concat(n.name,"-error")),e)})),i(o,e),console.log("clear")}var l=function(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))},s="https://nomoreparties.co/v1/cohort-magistr-2/",d="5ff08c9f-6c39-4cbe-b4be-5b7c70daa1f4",p=document.querySelector(".places__list"),f=document.querySelector(".profile__edit-button"),_=document.querySelector(".popup_type_edit"),m=document.querySelectorAll(".popup__close"),v=document.querySelector(".profile__add-button"),y=document.querySelector(".popup_type_new-card"),h=document.querySelectorAll(".popup"),g=document.querySelector(".profile__image"),S=document.querySelector(".profile__title"),b=document.querySelector(".profile__description"),k=document.forms["edit-profile"],C=k.elements.name,E=k.elements.description,q=document.forms["new-place"],L=q.elements["place-name"],x=q.elements.link,A=document.querySelector(".popup_type_update-avatar"),T=document.forms["new-avatar"],w=T.querySelector(".popup__button"),j=k.querySelector(".popup__button"),z=q.querySelector(".popup__button"),D="",B="",P=document.querySelector(".popup_type_image"),N=document.querySelector(".popup__image"),O=document.querySelector(".popup__caption"),J={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};function M(t){n(P),N.src=t.link,N.alt=t.name,O.textContent=t.name}function V(t){var e;t.preventDefault(),(e=t.target.closest(".card").id,fetch("".concat(s,"cards/").concat(e),{method:"DELETE",headers:{authorization:d,"Content-Type":"application/json"},body:JSON.stringify({_id:e})}).then((function(t){return l(t)}))).then((function(){t.target.closest(".card").remove()})).catch((function(t){console.log(t)}))}function H(t){var e,n=t.target.closest(".card"),o=n.querySelector(".card__likes");t.target.closest(".card__like-button_is-active")?(console.log("id:",n._id),(e=n.id,fetch("".concat(s,"cards/likes/").concat(e),{method:"DELETE",headers:{authorization:d,"Content-Type":"application/json"}}).then((function(t){return l(t)}))).then((function(e){console.log("LIKE",e),o.textContent=e.likes.length,t.target.classList.toggle("card__like-button_is-active")})).catch((function(t){console.log(t)})).finally((function(){}))):function(t){return fetch("".concat(s,"cards/likes/").concat(t),{method:"PUT",headers:{authorization:d,"Content-Type":"application/json"}}).then((function(t){return l(t)}))}(n.id).then((function(e){console.log("LIKE",e),o.textContent=e.likes.length,t.target.classList.toggle("card__like-button_is-active"),console.log(e)})).catch((function(t){console.log(t)}))}!function(t){Array.from(document.querySelectorAll(t.formSelector)).forEach((function(e){!function(t,e){var n=Array.from(t.querySelectorAll(e.inputSelector)),o=t.querySelector(e.submitButtonSelector);a(o,t.checkValidity(),e),n.forEach((function(n){n.addEventListener("input",(function(){!function(t,e,n){var o=e.validity.valid,r=t.querySelector("#".concat(e.name,"-error"));e.validity.patternMismatch?e.setCustomValidity(e.dataset.errorMessage):e.setCustomValidity(""),o?c(e,r,n):function(t,e,n){t.classList.add(n.inputErrorClass),e.classList.add(n.errorClass),e.textContent=t.validationMessage}(e,r,n)}(t,n,e),a(o,t.checkValidity(),e)}))})),t.addEventListener("submit",(function(t){t.preventDefault()}))}(e,t)}))}(J),v.addEventListener("click",(function(){q.reset(),u(q,J),n(y)})),f.addEventListener("click",(function(){C.value=S.textContent,E.value=b.textContent,u(k,J),n(_)})),g.addEventListener("click",(function(){T.reset(),u(T,J),n(A)})),T.addEventListener("submit",(function(t){var e;t.preventDefault(),w.textContent="Сохранение...",(e=T.avatar.value,fetch("".concat(s,"users/me/avatar "),{method:"PATCH",headers:{authorization:d,"Content-Type":"application/json"},body:JSON.stringify({avatar:e})}).then((function(t){return l(t)}))).then((function(t){g.removeAttribute("style"),g.setAttribute("style","background-image:url(".concat(t.avatar,")")),o(A)})).catch((function(t){console.log(t)})).finally((function(){w.textContent="Сохранить"}))})),k.addEventListener("submit",(function(t){var e,n;t.preventDefault(),j.textContent="Сохранение...",(e=C.value,n=E.value,fetch("".concat(s,"users/me"),{method:"PATCH",headers:{authorization:d,"Content-Type":"application/json"},body:JSON.stringify({name:e,about:n})}).then((function(t){return l(t)}))).then((function(t){S.textContent=C.value,b.textContent=E.value,o(_)})).catch((function(t){console.log(t)})).finally((function(){j.textContent="Сохранить"}))})),q.addEventListener("submit",(function(t){t.preventDefault(),z.textContent="Сохранение...";var n={name:L.value,link:x.value,likes:[]};n.owner={_id:D},function(t){return fetch("".concat(s,"cards"),{method:"POST",headers:{authorization:d,"Content-Type":"application/json"},body:JSON.stringify({name:t.name,link:t.link})}).then((function(t){return l(t)}))}(n).then((function(n){p.prepend(e(n,D,V,H,M)),q.reset(),o(t.target.closest(".popup"))})).catch((function(t){console.log(t)})).finally((function(){z.textContent="Сохранить"}))})),m.forEach((function(t){t.addEventListener("click",(function(t){o(t.target.closest(".popup"))}))})),h.forEach((function(t){t.addEventListener("click",(function(t){t.target===t.currentTarget&&o(t.target)}))})),Promise.all([fetch("".concat(s,"users/me"),{headers:{authorization:d}}).then((function(t){return l(t)})),fetch("".concat(s,"cards"),{headers:{authorization:d,"Content-Type":"application/json"}}).then((function(t){return l(t)}))]).then((function(t){S.textContent=t[0].name,b.textContent=t[0].about,D=t[0]._id,B=t[0].avatar,g.setAttribute("style","background-image:url(".concat(B,")")),t[1].forEach((function(t){var n={name:t.name,link:t.link,likes:t.likes,_id:t._id,owner:{_id:t.owner._id}};p.append(e(n,D,V,H,M))}))})).catch((function(t){console.log("Ошибка: "+t)}))})();